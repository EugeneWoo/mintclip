name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ─────────────────────────────────────────────────────────────
  # Detect which areas changed to skip unnecessary jobs
  # ─────────────────────────────────────────────────────────────
  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      extension: ${{ steps.filter.outputs.extension }}
      webapp: ${{ steps.filter.outputs.webapp }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/ci.yml'
            extension:
              - 'extension/**'
              - '.github/workflows/ci.yml'
            webapp:
              - 'web-app/**'
              - '.github/workflows/ci.yml'

  # ─────────────────────────────────────────────────────────────
  # JOB 1: Backend Python Tests
  # Runs only when backend/** or the workflow file changes
  # ─────────────────────────────────────────────────────────────
  backend-tests:
    name: Backend Tests (Python ${{ matrix.python-version }})
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('backend/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run tests
        env:
          # JWT config — local crypto only, no external service needed
          JWT_SECRET: test-jwt-secret-for-ci-only
          JWT_ALGORITHM: HS256
          JWT_ACCESS_TOKEN_EXPIRE_HOURS: "1"
          JWT_REFRESH_TOKEN_EXPIRE_DAYS: "30"
          # Supabase absent → is_supabase_available() returns False
          SUPABASE_URL: ""
          SUPABASE_ANON_KEY: ""
          SUPABASE_SERVICE_ROLE_KEY: ""
          # Gemini absent → GeminiClient.model stays None → methods return None
          GEMINI_API_KEY: ""
          # No REDIS_URL → cache falls back to SimpleCache automatically
          LOG_LEVEL: WARNING
          ENVIRONMENT: test
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --strict-markers \
            -p no:warnings \
            --reruns 2 \
            --reruns-delay 1 \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            -m "not slow and not integration"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11' && always()
        with:
          name: backend-coverage
          path: backend/coverage.xml

  # ─────────────────────────────────────────────────────────────
  # JOB 2: Extension Jest Tests
  # Runs only when extension/** or the workflow file changes
  # ─────────────────────────────────────────────────────────────
  extension-tests:
    name: Extension Tests (Jest)
    needs: changes
    if: needs.changes.outputs.extension == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: extension

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --ci --coverage --forceExit

  # ─────────────────────────────────────────────────────────────
  # JOB 3: Web App TypeScript + ESLint + Jest
  # Runs only when web-app/** or the workflow file changes
  # ─────────────────────────────────────────────────────────────
  web-app-checks:
    name: Web App (TypeScript + ESLint + Jest)
    needs: changes
    if: needs.changes.outputs.webapp == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: web-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install production dependencies
        run: npm ci

      - name: Install test dependencies
        run: |
          npm install --save-dev \
            jest@^29.7.0 \
            ts-jest@^29.1.0 \
            "@testing-library/react@^16.0.0" \
            "@testing-library/jest-dom@^6.0.0" \
            "@testing-library/user-event@^14.0.0" \
            "@types/jest@^29.5.0" \
            jest-environment-jsdom@^29.7.0

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: ESLint
        run: npx eslint src --ext ts,tsx --max-warnings 20
        continue-on-error: true

      - name: Run Jest tests
        run: npx jest --ci --coverage --forceExit
